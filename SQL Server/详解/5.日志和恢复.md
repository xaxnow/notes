### 内部事务日志

事务日志记录了对数据库的改变,存储足够的信息允许SQL Server恢复数据库.一个Sql Server 实例被启动,从备份恢复一个数据库或日志都会有恢复进程发生.恢复进程协调数据文件和日志文件.任何在log中已经提交的改变都表明必须出现在数据文件中,而未提交的则一定不会出现在数据文件中.log也存储事务回滚信息及错误(如死锁,生成内部回滚).

物理上,事务日志是与数据库关联的一个或多个的文件,执行数据库修改的操作记录将记录写入事务日志,以描述所作的更改.一些内部事件的发生也会写日志记录,如checkpoints,每条日志记录用LSN(log sequence number)标记以确保是唯一的.
所有日志条目Microsoft SQL Server内部链接同一事务的一部分，以便可以轻松地为撤消活动（如回滚）和重做活动（在系统恢复期间）定位事务的所有部分.

缓冲管理器保证在更改数据库之前写入事务日志(提前写).这个保证是合理的,因为SQL server使用日志的lsn跟踪它在日志中当前的位置.每次更改页面时，与该更改的日志条目相对应的LSN都会写入数据页面的标题中。 仅当页面上的LSN小于或等于写入日志的最后一条记录的LSN时，才可以将脏页面写入磁盘.缓冲区管理器还保证以特定顺序写入日志页，从而使系统故障后无论何时发生故障，都必须清除必须处理的日志块。

对事务日志记录写入磁盘之前确认发送到提交客户端进程，但实际改变的数据可能没有实际写入到数据页。虽然写入日志是异步的，在提交时的线程必须等待写操作完成对写日志的事务中提交记录的点。 （SQL服务器必须等待提交记录被写入，以便它知道有关的日志记录安全地在磁盘上。）写入数据页是完全同步的。也就是说，写入数据页只需要发布到操作系统和SQL Server可以在以后检查看看他们是完成。他们没有立即完成，因为日志包含需要重做的工作的所有信息，即使在电源故障或系统崩溃的写入事件之前完成。系统将慢得多，如果它要等待每个I / O请求完成继续前。

记录涉及划定每个事务的开始和结束（和保存点，如果交易使用它们）。开始和结束之间的分界线是关于信息改变对数据所作的。该信息可采取实际的形式，“之前和之后”的数据，或者它可以指进行，使得这些值可以导出操作。一个典型的端部事务标有提交记录，这表明该事务必须反映在数据库的数据文件或重做如果需要的话。正常运行时退出的事务（不系统重启），由于明确的回滚或类似的资源错误（例如，超出内存的存储器错误）实际上通过应用撤消原始数据的变化撤消操作修改。这些变化的记录被写入日志，并标记为“补偿日志记录。”

已提交的事务日志未被写入数据文件:前滚(redo 阶段恢复:在数据库事务被提交了(被写入log),但并未写入数据文件)写入数据文件的变化与与已提交的不一致:回滚(undo阶段恢复:在事务被提交之前,写入未提交的变化到磁盘,此时数据库宕机了,恢复进程则在数据文件中找到未提交的数据并回滚)

#### 恢复的阶段
```
1.分析
2.redo
3.undo
```