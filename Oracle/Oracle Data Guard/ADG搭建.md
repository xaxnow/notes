## 1.主库操作(pri)
### 1.1.开启force logging和归档
```sql
alter database force logging;
shutdown immediate;
startup mount;
alter database archivelog;
```
### 1.3.创建standby redolog日志组
```sql
/* 1.standby redo log的文件大小与primary 数据库online redo log 文件大小相同
2：standby redo log日志文件组的个数依照下面的原则进行计算：
	Standby redo log组数公式>=(每个instance日志组个数+1)*instance个数
	假如只有一个节点，这个节点有三组redolog，
	所以Standby redo log组数>=(3+1)*1 == 4
    所以至少需要创建4组Standby redo log */
alter database add standby logfile group 4 ('/u01/app/oracle/oradata/pri/std01') size 50M;
alter database add standby logfile group 5 ('/u01/app/oracle/oradata/pri/std02') size 50M;
alter database add standby logfile group 6 ('/u01/app/oracle/oradata/pri/std03') size 50M;
alter database add standby logfile group 7 ('/u01/app/oracle/oradata/pri/std04') size 50M;
```
### 1.2.从spfile生成pfile文件,并编辑pfile
```sql
create pfile from spfile;
#编辑pfile
pri.__db_cache_size=88080384
pri.__java_pool_size=4194304
pri.__large_pool_size=71303168
pri.__oracle_base='/u01/app/oracle'#ORACLE_BASE set from environment
pri.__pga_aggregate_target=142606336
pri.__sga_target=268435456
pri.__shared_io_pool_size=0
pri.__shared_pool_size=92274688
pri.__streams_pool_size=0
*.audit_file_dest='/u01/app/oracle/admin/pri/adump'
*.audit_trail='db'
*.compatible='11.2.0.0'
*.control_files='/u01/app/oracle/oradata/pri/control01.ctl','/u01/app/oracle/fast_recovery_area/pri/control02.ctl'
*.db_block_size=8192
*.db_domain=''
*.db_name='pri'
*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=4385144832
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=priXDB)'
*.memory_target=408944640
*.open_cursors=300
*.processes=150
*.remote_login_passwordfile='EXCLUSIVE'
*.undo_tablespace='UNDOTBS1'
#add in the ending
DB_UNIQUE_NAME=pri
LOG_ARCHIVE_CONFIG='DG_CONFIG=(pri,std)'
LOG_ARCHIVE_DEST_1=
'LOCATION=/u01/app/oracle/fast_recovery_area
VALID_FOR=(ALL_LOGFILES,ALL_ROLES)
DB_UNIQUE_NAME=pri'
LOG_ARCHIVE_DEST_2=
'SERVICE=std lgwr ASYNC
VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE)
DB_UNIQUE_NAME=std'
LOG_ARCHIVE_DEST_STATE_1=ENABLE
LOG_ARCHIVE_DEST_STATE_2=ENABLE
REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE
LOG_ARCHIVE_FORMAT=%t%s_%r.arc

#std use parameters
FAL_SERVER=std
DB_FILE_NAME_CONVERT='std','pri'
LOG_FILE_NAME_CONVERT='std','pri'
STANDBY_FILE_MANAGEMENT=AUTO
#the explain is given in ending
```
### 1.3.编辑listener.ora
```sql
# listener.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER1 =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.3)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER1 = /u01/app/oracle

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.3)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
#change the host using ip,and add content the following
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = pri)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1)
      (SID_NAME =pri)
    )
  )

```
### 1.4.编辑tnsname.ora
```sql
# tnsnames.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

pri =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.3)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = pri)
    )
  )
#change the primary database host using ip,and add standby database configuration
STD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.2)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = std)
    )
  )
  ```
  ### 1.5.复制pfile,密码文件,listener.ora,tnsname.ora至备库对应的目录
  ```
  scp pfile|orapwpri|listener.ora|tnsname.ora 192.168.139.2:same_dir
  ```
  ## 2.备库操作(std)
  ### 2.1.重命名从主库来的pfile,密码文件;并编辑pfile
  ```sql
  mv initpri initstd
  mv orapwpri orapwstd
  #edit pfile,use standby_db_name replace primary_db_name,but *.db_name should be primary db_name.and the dir should be care
  std.__db_cache_size=88080384
std.__java_pool_size=4194304
std.__large_pool_size=71303168
std.__oracle_base='/u01/app/oracle'#ORACLE_BASE set from environment
std.__pga_aggregate_target=142606336
std.__sga_target=268435456
std.__shared_io_pool_size=0
std.__shared_pool_size=92274688
std.__streams_pool_size=0
*.audit_file_dest='/u01/app/oracle/admin/std/adump'
*.audit_trail='db'
*.compatible='11.2.0.0'
*.control_files='/u01/app/oracle/oradata/std/control01.ctl','/u01/app/oracle/fast_recovery_area/std/control02.ctl'
*.db_block_size=8192
*.db_domain=''
*.db_name='pri'#should be parimary db_name
*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=4385144832
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=stdXDB)'
*.memory_target=408944640
*.open_cursors=300
*.processes=150
*.remote_login_passwordfile='EXCLUSIVE'
*.undo_tablespace='UNDOTBS1'

DB_UNIQUE_NAME='std'
/*代表该Dataguard是两个节点，一主一从，若要配置多个节点，则需要在此处添加。*/
LOG_ARCHIVE_CONFIG='DG_CONFIG=(pri,std)'
/*location代表本地归档。在这里我们使用闪回区(USE_DB_RECOVERY_FILE_DEST)作为在线日志文件的归档目录，在实际生产环境中，如果归档日志是归档在本地文件系统上，不建议使用闪回区，因为闪回区和数据库软件是在同一个目录下，如果归档日志过多，闪回区空间增长过快，容易造成磁盘空间不足，这样容易使数据库挂掉。valid_for代表该归档目录只有在该库为主库，归档在线日志文件时才有效。*/
LOG_ARCHIVE_DEST_1=
'LOCATION=/u01/app/oracle/fast_recovery_area
VALID_FOR=(ALL_LOGFILES,ALL_ROLES)
DB_UNIQUE_NAME=std'
LOG_ARCHIVE_DEST_2=
'SERVICE=pri lgwr ASYNC
VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE)
DB_UNIQUE_NAME=pri'
LOG_ARCHIVE_DEST_STATE_1=ENABLE
LOG_ARCHIVE_DEST_STATE_2=ENABLE
REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE
LOG_ARCHIVE_FORMAT=%t%s_%r.arc

/*std use*/
FAL_SERVER='pri'
DB_FILE_NAME_CONVERT='pri','std'
LOG_FILE_NAME_CONVERT='pri','std'
STANDBY_FILE_MANAGEMENT=AUTO
```
### 2.2.编辑listener.ora
```sql
# listener.ora Network Configuration File: /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER1 =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.2)(PORT = 1521))
    )
  )

ADR_BASE_LISTENER1 = /u01/app/oracle

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.139.2)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = std)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1)
      (SID_NAME =std)
    )
  )
```
### 2.3.重启两机监听,并相互tnsping
```
lsnrctl reload
tnsping sid
```
### 2.4.创建目录并修改权限
```sql
cd /u01/app/oracle/admin
mkdir -p /u01/app/oracle/admin/std/adump /u01/app/oracle/admin/std/dpdump /u01/app/oracle/admin/std/pfile /u01/app/oracle/oradata/std/ /u01/app/oracle/fast_recovery_area/std/
chown -R oracle:dba /u01/app/oracle/admin/std/adump /u01/app/oracle/admin/std/dpdump /u01/app/oracle/admin/std/pfile /u01/app/oracle/oradata/std/ /u01/app/oracle/fast_recovery_area/std/
chmod -R 750 /u01/app/oracle/admin/std/adump /u01/app/oracle/admin/std/dpdump /u01/app/oracle/admin/std/pfile /u01/app/oracle/oradata/std/ /u01/app/oracle/fast_recovery_area/std/
```
### 2.4.使用修改后的pfile建立spfile并启动数据库
```sql
sqlplus / as sysdba
create spfile from pfile;
startup nomount;
```
### 2.5.使用rman在备库恢复主库数据
```sql
rman target sys/sys@pri auxiliary sys/sys@std
duplicate target database for standby from active database nofilenamecheck;
```
### 2.6.开启数据保护模式
```sql
--mount状态
alter database open;
ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE {PROTECTION | AVAILABILITY | PERFORMANCE};
select protection_mode,protection_level  from v$database; --查看保护模式
```
### 2.7.开启实时/非实时应用日志
```sql
alter database open;
alter database recover managed standby database using current logfile disconnect;  --实时(应用redo)
alter database recover managed standby database disconnect from session;  --非实时(应用归档)
select process, status, sequence# from v$managed_standby; --查看是否实时(WAIT_FOR_LOG非实时)
--取消应用日志
alter database recover managed standby database cancel;
```
### 3.验证是否成功
`向表中插入数据看备库能否看到`